<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: models/plugin.instance.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">Home</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="DataCaptureThread.html">DataCaptureThread</a></div><div class="sidebar-section-children"><a href="InternalStateManager.html">InternalStateManager</a></div><div class="sidebar-section-children"><a href="Logger.html">Logger</a></div><div class="sidebar-section-children"><a href="NetworkRequest.html">NetworkRequest</a></div><div class="sidebar-section-children"><a href="NetworkRequestsHandler.html">NetworkRequestsHandler</a></div><div class="sidebar-section-children"><a href="NodeManager.html">NodeManager</a></div><div class="sidebar-section-children"><a href="Pipeline.html">Pipeline</a></div><div class="sidebar-section-children"><a href="PluginInstance.html">PluginInstance</a></div><div class="sidebar-section-children"><a href="RedisStateManager.html">RedisStateManager</a></div><div class="sidebar-section-children"><a href="State.html">State</a></div><div class="sidebar-section-children"><a href="ZxAIBC.html">ZxAIBC</a></div><div class="sidebar-section-children"><a href="ZxAIClient.html">ZxAIClient</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#AlertedNodes">AlertedNodes</a></div><div class="sidebar-section-children"><a href="global.html#AllowedValues">AllowedValues</a></div><div class="sidebar-section-children"><a href="global.html#AvailableDCTResponse">AvailableDCTResponse</a></div><div class="sidebar-section-children"><a href="global.html#AvailableSchemaResponse">AvailableSchemaResponse</a></div><div class="sidebar-section-children"><a href="global.html#Field">Field</a></div><div class="sidebar-section-children"><a href="global.html#IntervalDefinition">IntervalDefinition</a></div><div class="sidebar-section-children"><a href="global.html#IsObject">IsObject</a></div><div class="sidebar-section-children"><a href="global.html#NodeStatus">NodeStatus</a></div><div class="sidebar-section-children"><a href="global.html#ObservedNodes">ObservedNodes</a></div><div class="sidebar-section-children"><a href="global.html#RedisConnectionOptions">RedisConnectionOptions</a></div><div class="sidebar-section-children"><a href="global.html#SchemaCollection">SchemaCollection</a></div><div class="sidebar-section-children"><a href="global.html#SchemaDefinition">SchemaDefinition</a></div><div class="sidebar-section-children"><a href="global.html#SchemasRepository">SchemasRepository</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIBlockchainOptions">ZxAIBlockchainOptions</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIClientEvent">ZxAIClientEvent</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIClientOptions">ZxAIClientOptions</a></div><div class="sidebar-section-children"><a href="global.html#ZxAICommand">ZxAICommand</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIEventType">ZxAIEventType</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIUpdateInstanceConfig">ZxAIUpdateInstanceConfig</a></div><div class="sidebar-section-children"><a href="global.html#applyDefaultsToObject">applyDefaultsToObject</a></div><div class="sidebar-section-children"><a href="global.html#archiveConfigRequestStrategy">archiveConfigRequestStrategy</a></div><div class="sidebar-section-children"><a href="global.html#base64ToUrlSafeBase64">base64ToUrlSafeBase64</a></div><div class="sidebar-section-children"><a href="global.html#camelToZxAIFormat">camelToZxAIFormat</a></div><div class="sidebar-section-children"><a href="global.html#checkMandatoryFields">checkMandatoryFields</a></div><div class="sidebar-section-children"><a href="global.html#checkType">checkType</a></div><div class="sidebar-section-children"><a href="global.html#computeDifferences">computeDifferences</a></div><div class="sidebar-section-children"><a href="global.html#convertKeysToCamelFormat">convertKeysToCamelFormat</a></div><div class="sidebar-section-children"><a href="global.html#convertKeysToZxAIFormat">convertKeysToZxAIFormat</a></div><div class="sidebar-section-children"><a href="global.html#dctSchemas">dctSchemas</a></div><div class="sidebar-section-children"><a href="global.html#decode">decode</a></div><div class="sidebar-section-children"><a href="global.html#defaultSchemas">defaultSchemas</a></div><div class="sidebar-section-children"><a href="global.html#encode">encode</a></div><div class="sidebar-section-children"><a href="global.html#generateId">generateId</a></div><div class="sidebar-section-children"><a href="global.html#getRedisConnection">getRedisConnection</a></div><div class="sidebar-section-children"><a href="global.html#hasFleetFilter">hasFleetFilter</a></div><div class="sidebar-section-children"><a href="global.html#identityFormatter">identityFormatter</a></div><div class="sidebar-section-children"><a href="global.html#pick">pick</a></div><div class="sidebar-section-children"><a href="global.html#rawIn">rawIn</a></div><div class="sidebar-section-children"><a href="global.html#schema">schema</a></div><div class="sidebar-section-children"><a href="global.html#schema">schema</a></div><div class="sidebar-section-children"><a href="global.html#schema">schema</a></div><div class="sidebar-section-children"><a href="global.html#schema">schema</a></div><div class="sidebar-section-children"><a href="global.html#schemas">schemas</a></div><div class="sidebar-section-children"><a href="global.html#sleep">sleep</a></div><div class="sidebar-section-children"><a href="global.html#updateConfigRequestStrategy">updateConfigRequestStrategy</a></div><div class="sidebar-section-children"><a href="global.html#updatePipelineInstanceRequestStrategy">updatePipelineInstanceRequestStrategy</a></div><div class="sidebar-section-children"><a href="global.html#urlSafeBase64ToBase64">urlSafeBase64ToBase64</a></div><div class="sidebar-section-children"><a href="global.html#validateAgainstSchema">validateAgainstSchema</a></div><div class="sidebar-section-children"><a href="global.html#zxAIFormatToCamel">zxAIFormatToCamel</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">models_plugin.instance.js</h1></header><article><pre class="prettyprint source lang-js"><code>import { NODE_COMMAND_UPDATE_PIPELINE_INSTANCE, STICKY_COMMAND_ID_KEY } from '../constants.js';
import {
    applyDefaultsToObject,
    checkMandatoryFields,
    computeDifferences,
    generateId,
    IsObject,
    validateAgainstSchema,
} from '../utils/helper.functions.js';

export const ID_TAGS = 'ID_TAGS';
export const WORKING_HOURS = 'WORKING_HOURS';
export const LINKED_INSTANCES = 'LINKED_INSTANCES';
export const SINGLE_INSTANCE = 'SINGLE_INSTANCE';
export const reservedKeys = [ID_TAGS, WORKING_HOURS, LINKED_INSTANCES, SINGLE_INSTANCE];

/**
 * @class PluginInstance
 *
 * This is the model that enables the interaction with the plugin instances running on the network node pipelines.
 * Please see the network documentation for a detailed description of the Plugin Instances.
 *
 * A PluginInstance is defined by a config object, a set of tags and the instance working hours.  Use the `make` method
 * for creating new `PluginInstance`s to ensure the proper validation of all the assets needed for correct
 * instantiation.
 */
export class PluginInstance {
    /**
     * Flag signaling that this plugin instance has changes that need to be committed to the network.
     *
     * @type {boolean}
     */
    isDirty = false;

    /**
     * The instance id.
     *
     * @type {string | null}
     */
    id = null;

    /**
     * The plugin signature.
     *
     * @type {string}
     */
    signature = null;

    /**
     * The instance config as it is on the Plugin Instance running on the DecentrAI Network node.
     *
     * @type {Object}
     */
    config = {};

    /**
     * Instance stats, including errors, error times, etc.
     *
     * @type {Object}
     */
    stats = {};

    /**
     * Instance tags.
     *
     * @type {Object}
     */
    tags = {};

    /**
     * The instance schedule.
     *
     * @type {Object}
     */
    schedule = {};

    /**
     * Flag for signalling if this particular instance is outside its configured working schedule.
     *
     * @type {boolean}
     */
    outsideWorkingHours = false;

    /**
     * The frequency with which this instance consumes inputs from the pipeline's DCT.
     *
     * @type {number|null}
     */
    frequency = 0;

    /**
     * Handler for the pipeline model this instance is deployed on.
     *
     * @type Pipeline
     */
    pipeline;

    /**
     * Instances to collect results from.
     *
     * @type {Array&lt;string>}
     */
    linkedInstances = [];

    /**
     * The collector instance if this instance has its results collected by another instance.
     *
     * @type {string | null}
     */
    collectorInstance = null;

    /**
     * The config object schema definition.
     *
     * @type {SchemaDefinition|null}
     */
    schema = null;

    /**
     * The PluginInstance constructor.
     *
     * @param {string} id
     * @param {string} signature
     * @param {*} config
     * @param {SchemaDefinition} schema
     * @param {boolean} dirty
     * @private
     */
    constructor(id, signature, config, schema = null, dirty = false) {
        this.id = id;
        this.schema = schema;
        this.signature = signature;
        this.config = config;
        this.tags = {};
        this.isDirty = dirty;
    }

    /**
     * Factory method for creating new `PluginInstance`s.
     *
     * The setup object should provide a config object and a schema for proper instantiation of the PluginInstance. If
     * the `schema` is provided, then this method will attempt to validate the config object based on the schema rules
     * and throw any errors.
     *
     * @param {Object} setup
     * @param {Pipeline|null} pipeline
     * @return {PluginInstance}
     */
    static make(setup, pipeline = null) {
        // TODO: setup.signature missing -> throw error

        let cleanConfig = setup.config ?? {};
        const schema = setup.schema;

        let useId = setup.id;
        if (!useId) {
            useId = generateId();
        }

        if (schema !== null &amp;&amp; schema.fields !== null &amp;&amp; Array.isArray(schema.fields)) {
            cleanConfig = applyDefaultsToObject(cleanConfig, schema);
            if (!checkMandatoryFields(cleanConfig, schema)) {
                throw new Error(
                    "Mandatory fields are missing from the plugin instance configuration. Couldn't properly instantiate.",
                );
            }

            const errors = validateAgainstSchema(cleanConfig, schema);
            if (errors.length > 0) {
                throw new Error(`Errors encountered when validating: \n ${errors.join('\n')}`);
            }
        }

        const instance = new PluginInstance(useId, setup.signature, cleanConfig, schema, setup.dirty ?? false)
            .updateStats(setup.stats ?? null)
            .bulkSetTags(setup.tags ?? {})
            .setSchedule(setup.schedule, !setup.dirty);

        if (pipeline) {
            instance.setPipeline(pipeline);
        }

        return instance;
    }

    /**
     * Returns the id of the pipeline this plugin instance is working on.
     *
     * @return {string}
     */
    getPipelineId() {
        return this.pipeline.id;
    }

    /**
     * Returns the instance's schema.
     *
     * @return {SchemaDefinition}
     */
    getSchema() {
        return this.schema ?? null;
    }

    /**
     * Retrieves the running config from the PluginInstance model. The returned config will be remapped
     * on the schema if it exists.
     *
     * @return {Object}
     */
    getConfig() {
        let cleanConfig = {};
        const schema = this.schema?.fields ?? null;

        if (schema) {
            schema.forEach((fieldDefinition) => {
                cleanConfig[fieldDefinition.key] = this.config[fieldDefinition.key] ?? fieldDefinition.default;
            });
        } else {
            cleanConfig = this.config;
        }

        return cleanConfig;
    }

    /**
     * Method for updating the config on this instance.
     *
     * @param {Object} update
     * @return {PluginInstance}
     */
    updateConfig(update) {
        const errors = validateAgainstSchema(update, this.schema);
        if (errors.length > 0) {
            throw new Error(`Errors encountered when validating: \n ${errors.join('\n')}`);
        }

        this.config = Object.assign(this.config, update);
        this.isDirty = true;
        this.pipeline.addInstanceWatch([this.pipeline.node, this.pipeline.id, this.signature, this.id]);

        return this;
    }

    /**
     * Returns `true` if this plugin instance is linkable with others based on the associated schema.
     *
     * @return {boolean}
     */
    isLinkable() {
        return this.schema?.options?.linkable ?? false;
    }

    /**
     * Returns `true` if plugin instance is either collecting other instances or if its output is collected by another.
     *
     * @return {boolean}
     */
    isLinked() {
        return this.isLinkable() &amp;&amp; (this.linkedInstances.length > 0 || this.collectorInstance !== null);
    }

    /**
     * Returns `true` if this particular instance's output is collected by another instance.
     *
     * @return {boolean}
     */
    isCollected() {
        return this.collectorInstance !== null;
    }

    /**
     * Returns `true` if this instance is the main instance, collecting and reporting output from other instances.
     *
     * @return {boolean}
     */
    isCollecting() {
        return this.linkedInstances.length > 0;
    }

    /**
     * Returns the list of collected instances.
     *
     * @return {Array&lt;string>}
     */
    getLinkedInstances() {
        return this.linkedInstances;
    }

    /**
     * Returns the path of the collecting instance.
     *
     * @return {string|null}
     */
    getCollectorInstance() {
        return this.collectorInstance;
    }

    /**
     * Sets `this` instance as collected by the provided `instance`.
     *
     * @param {PluginInstance} instance
     * @return {PluginInstance}
     */
    setCollectorInstance(instance) {
        this.collectorInstance = `${instance.pipeline.id}:${instance.id}`;
        this.isDirty = true;

        return this;
    }

    // TODO: this is dangerous to have available
    /**
     * Removes all links to this instance.
     *
     * @return {PluginInstance}
     */
    purgeLinks() {
        this.collectorInstance = null;
        this.linkedInstances = [];
        this.isDirty = true;

        return this;
    }

    /**
     * Returns `true` if this instance is collecting data from the `tester` instance provided.
     *
     * @param {PluginInstance} tester
     * @return {boolean}
     */
    isCollectingFrom(tester) {
        if (this.linkedInstances.length === 0) {
            return false;
        }

        for (const link of this.linkedInstances) {
            const [pipelineId, instanceId] = link.split(':');
            if (instanceId === tester.id &amp;&amp; pipelineId === tester.pipeline.id) {
                return true;
            }
        }

        return false;
    }

    /**
     * Attempts to link `this` instance to the `candidate` instance.
     *
     * @param {PluginInstance} candidate
     * @return {PluginInstance}
     */
    link(candidate) {
        const targetMetadata = candidate.schema;
        const thisMetadata = this.schema;

        if (
            targetMetadata.type === thisMetadata.type &amp;&amp;
            targetMetadata.options?.linkable &amp;&amp;
            thisMetadata.options?.linkable &amp;&amp;
            !this.isCollectingFrom(candidate)
        ) {
            this.linkedInstances.push(`${candidate.pipeline.id}:${candidate.id}`);
            candidate.setCollectorInstance(this);
            this.isDirty = true;
        }

        return this;
    }

    /**
     * Removes the link between `this` instance and the provided `linkedInstance` instance.
     *
     * @param {PluginInstance} linkedInstance
     * @return {PluginInstance}
     */
    unlink(linkedInstance) {
        linkedInstance.setCollectorInstance(null);

        for (let i = 0; i &lt; this.linkedInstances.length; i++) {
            const [pipelineId, instanceId] = this.linkedInstances[i].split(':');

            if (pipelineId === linkedInstance.pipeline.id &amp;&amp; instanceId === linkedInstance.id) {
                this.linkedInstances.splice(i, 1);
                this.isDirty = true;
            }
        }

        return this;
    }

    /**
     * Removes a tag from the instance if it exists.
     *
     * @param {string} key - The key of the tag to remove.
     * @returns {PluginInstance} The instance of PluginInstance to allow method chaining.
     */
    removeTag(key) {
        if (this.tags[key]) {
            delete this.tags[key];
        }

        return this;
    }

    /**
     * Adds a tag to the instance or updates an existing tag.
     *
     * @param {string} key - The key of the tag to add or update.
     * @param {string} value - The value of the tag to add or update.
     * @returns {PluginInstance} The instance of PluginInstance to allow method chaining.
     */
    addTag(key, value) {
        this.tags[key] = value;

        return this;
    }

    /**
     * Retrieves all tags from the instance.
     *
     * @returns {Object} An object containing all tags.
     */
    getTags() {
        return this.tags;
    }

    /**
     * Resets all tags to an empty object.
     *
     * @returns {PluginInstance} The instance of PluginInstance to allow method chaining.
     */
    resetTags() {
        this.tags = {};

        return this;
    }

    /**
     * Sets multiple tags at once, replacing any existing tags.
     *
     * @param {Object} tags - An object containing multiple tags to set.
     * @returns {PluginInstance} The instance of PluginInstance to allow method chaining.
     */
    bulkSetTags(tags) {
        this.tags = tags;

        return this;
    }

    /**
     * Retrieves the current working hours schedule of the instance.
     *
     * @returns {Object|Array} The current schedule. Returns an object for schedules
     * specific to days of the week, or an array for a uniform schedule across all days.
     */
    getSchedule() {
        return this.schedule;
    }

    /**
     * Sets the working hours schedule for the instance.
     * This method accepts either a detailed schedule for each day of the week
     * or a single schedule for all days.
     *
     * @param {Object|Array} schedule - The schedule to set. If an object, it should
     * map days to time intervals. If an array, it applies the same schedule to all days.
     * @param {boolean} dontMarkDirty
     *
     * @returns {PluginInstance} The instance of PluginInstance to allow method chaining.
     */
    setSchedule(schedule, dontMarkDirty = false) {
        this._validateSchedule(schedule);
        this.schedule = schedule;
        this.isDirty = !dontMarkDirty;

        return this;
    }

    /**
     * Method for updating the running stats on this instance.
     *
     * @param {Object} stats
     * @return {PluginInstance}
     */
    updateStats(stats = {}) {
        this.frequency = stats.FREQUENCY ?? null;
        this.stats = stats;
        this.outsideWorkingHours = stats.OUTSIDE_WORKING_HOURS ?? false;

        return this;
    }

    /**
     * Returns the instance running statistics.
     *
     * @return {Object}
     */
    getInstanceStats() {
        return this.stats;
    }

    /**
     * Sets the pipeline on which this instance is running.
     *
     * @param {Pipeline} pipeline
     * @return {PluginInstance}
     */
    setPipeline(pipeline) {
        this.pipeline = pipeline;

        return this;
    }

    /**
     * Sends a command to the instance running on the DecentrAI Network node.
     *
     * @param {Object} command
     * @return {Promise&lt;Object>}
     */
    sendCommand(command) {
        return this.pipeline.getClient().publish(this.pipeline.getNode(), this.getRawInstanceCommandPayload(command));
    }

    /**
     * Computes the instance update config by comparing the config running on the DecentrAI Node with the proposed
     * configuration stored on the instance model.
     *
     * @return {Promise&lt;ZxAIUpdateInstanceConfig>}
     */
    async makeUpdateInstancePayload() {
        const candidateConfig = this.compile();
        const runningConfig = await this.pipeline
            .getClient()
            .state.getRunningInstanceConfig(this.pipeline.node, this.pipeline.id, this.id);

        const changeSet = computeDifferences(runningConfig, candidateConfig);
        if (changeSet !== null) {
            return {
                NAME: this.pipeline.id,
                INSTANCE_ID: this.id,
                SIGNATURE: this.signature,
                INSTANCE_CONFIG: changeSet,
            };
        }

        return null;
    }

    /**
     * Puts together all the information in one config object.
     *
     * @return {Object}
     */
    compile() {
        const config = this.config;

        if (Object.keys(this.tags).length) {
            config[ID_TAGS] = {};
            Object.keys(this.tags).forEach((key) => {
                config[ID_TAGS][`${key}`] = this.tags[key];
            });
        }

        if (
            (Array.isArray(this.schedule) &amp;&amp; this.schedule.length > 0) ||
            (IsObject(this.schedule) &amp;&amp; Object.keys(this.schedule).length > 0)
        ) {
            config[WORKING_HOURS] = this.schedule;
        } else {
            config[WORKING_HOURS] = [];
        }

        if (this.isLinkable()) {
            if (!this.isCollected() &amp;&amp; !this.isCollecting()) {
                config[SINGLE_INSTANCE] = true;
                config[LINKED_INSTANCES] = [];
            } else if (this.isCollected()) {
                config[SINGLE_INSTANCE] = false;
                config[LINKED_INSTANCES] = [];
            } else if (this.isCollecting()) {
                config[LINKED_INSTANCES] = this.linkedInstances.map((linkPath) => linkPath.split(':'));
            }
        }

        return this.config;
    }

    /**
     * Returns the instance command wrapped within an DecentrAI Node command.
     *
     * @param command
     * @return {ZxAICommand}
     */
    getRawInstanceCommandPayload(command) {
        command[STICKY_COMMAND_ID_KEY] = generateId();

        return {
            PAYLOAD: {
                NAME: this.pipeline.id,
                INSTANCE_ID: this.id,
                SIGNATURE: this.signature,
                INSTANCE_CONFIG: {
                    INSTANCE_COMMAND: command,
                },
            },
            ACTION: NODE_COMMAND_UPDATE_PIPELINE_INSTANCE,
        };
    }

    /**
     * Validates the structure and content of the schedule object.
     * For separate schedules, ensures each key is a valid day and each value is an array of time intervals.
     * For a single schedule for all days, ensures it's an array of time intervals.
     * Time intervals should be in the format ["HH:MM", "HH:MM"].
     *
     * @private
     * @param {Object|Array} schedule - The schedule to validate.
     * @returns {boolean} True if the schedule is valid, otherwise throws an Error.
     */
    _validateSchedule(schedule) {
        const isValidTime = (time) => /^\d{2}:\d{2}$/.test(time);
        const isValidInterval = (interval) =>
            Array.isArray(interval) &amp;&amp; interval.length === 2 &amp;&amp; interval.every(isValidTime);
        const daysOfWeek = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];

        if (Array.isArray(schedule)) {
            if (schedule.length !== 0 &amp;&amp; !schedule.every(isValidInterval)) {
                throw new Error('Invalid schedule format: Each interval must be an array of two valid times.');
            }
        } else if (typeof schedule === 'object') {
            Object.entries(schedule).forEach(([day, intervals]) => {
                if (!daysOfWeek.includes(day)) {
                    throw new Error(`Invalid schedule day: ${day} is not a valid day of the week.`);
                }
                if (!Array.isArray(intervals) || !intervals.every(isValidInterval)) {
                    throw new Error(
                        `Invalid schedule format for ${day}: Each interval must be an array of two valid times.`,
                    );
                }
            });
        } else {
            throw new Error('Invalid schedule type: Schedule must be either an array or an object.');
        }

        return true;
    }
}
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">Home</a><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="DataCaptureThread.html">DataCaptureThread</a></div><div class="sidebar-section-children"><a href="InternalStateManager.html">InternalStateManager</a></div><div class="sidebar-section-children"><a href="Logger.html">Logger</a></div><div class="sidebar-section-children"><a href="NetworkRequest.html">NetworkRequest</a></div><div class="sidebar-section-children"><a href="NetworkRequestsHandler.html">NetworkRequestsHandler</a></div><div class="sidebar-section-children"><a href="NodeManager.html">NodeManager</a></div><div class="sidebar-section-children"><a href="Pipeline.html">Pipeline</a></div><div class="sidebar-section-children"><a href="PluginInstance.html">PluginInstance</a></div><div class="sidebar-section-children"><a href="RedisStateManager.html">RedisStateManager</a></div><div class="sidebar-section-children"><a href="State.html">State</a></div><div class="sidebar-section-children"><a href="ZxAIBC.html">ZxAIBC</a></div><div class="sidebar-section-children"><a href="ZxAIClient.html">ZxAIClient</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#AlertedNodes">AlertedNodes</a></div><div class="sidebar-section-children"><a href="global.html#AllowedValues">AllowedValues</a></div><div class="sidebar-section-children"><a href="global.html#AvailableDCTResponse">AvailableDCTResponse</a></div><div class="sidebar-section-children"><a href="global.html#AvailableSchemaResponse">AvailableSchemaResponse</a></div><div class="sidebar-section-children"><a href="global.html#Field">Field</a></div><div class="sidebar-section-children"><a href="global.html#IntervalDefinition">IntervalDefinition</a></div><div class="sidebar-section-children"><a href="global.html#IsObject">IsObject</a></div><div class="sidebar-section-children"><a href="global.html#NodeStatus">NodeStatus</a></div><div class="sidebar-section-children"><a href="global.html#ObservedNodes">ObservedNodes</a></div><div class="sidebar-section-children"><a href="global.html#RedisConnectionOptions">RedisConnectionOptions</a></div><div class="sidebar-section-children"><a href="global.html#SchemaCollection">SchemaCollection</a></div><div class="sidebar-section-children"><a href="global.html#SchemaDefinition">SchemaDefinition</a></div><div class="sidebar-section-children"><a href="global.html#SchemasRepository">SchemasRepository</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIBlockchainOptions">ZxAIBlockchainOptions</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIClientEvent">ZxAIClientEvent</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIClientOptions">ZxAIClientOptions</a></div><div class="sidebar-section-children"><a href="global.html#ZxAICommand">ZxAICommand</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIEventType">ZxAIEventType</a></div><div class="sidebar-section-children"><a href="global.html#ZxAIUpdateInstanceConfig">ZxAIUpdateInstanceConfig</a></div><div class="sidebar-section-children"><a href="global.html#applyDefaultsToObject">applyDefaultsToObject</a></div><div class="sidebar-section-children"><a href="global.html#archiveConfigRequestStrategy">archiveConfigRequestStrategy</a></div><div class="sidebar-section-children"><a href="global.html#base64ToUrlSafeBase64">base64ToUrlSafeBase64</a></div><div class="sidebar-section-children"><a href="global.html#camelToZxAIFormat">camelToZxAIFormat</a></div><div class="sidebar-section-children"><a href="global.html#checkMandatoryFields">checkMandatoryFields</a></div><div class="sidebar-section-children"><a href="global.html#checkType">checkType</a></div><div class="sidebar-section-children"><a href="global.html#computeDifferences">computeDifferences</a></div><div class="sidebar-section-children"><a href="global.html#convertKeysToCamelFormat">convertKeysToCamelFormat</a></div><div class="sidebar-section-children"><a href="global.html#convertKeysToZxAIFormat">convertKeysToZxAIFormat</a></div><div class="sidebar-section-children"><a href="global.html#dctSchemas">dctSchemas</a></div><div class="sidebar-section-children"><a href="global.html#decode">decode</a></div><div class="sidebar-section-children"><a href="global.html#defaultSchemas">defaultSchemas</a></div><div class="sidebar-section-children"><a href="global.html#encode">encode</a></div><div class="sidebar-section-children"><a href="global.html#generateId">generateId</a></div><div class="sidebar-section-children"><a href="global.html#getRedisConnection">getRedisConnection</a></div><div class="sidebar-section-children"><a href="global.html#hasFleetFilter">hasFleetFilter</a></div><div class="sidebar-section-children"><a href="global.html#identityFormatter">identityFormatter</a></div><div class="sidebar-section-children"><a href="global.html#pick">pick</a></div><div class="sidebar-section-children"><a href="global.html#rawIn">rawIn</a></div><div class="sidebar-section-children"><a href="global.html#schema">schema</a></div><div class="sidebar-section-children"><a href="global.html#schema">schema</a></div><div class="sidebar-section-children"><a href="global.html#schema">schema</a></div><div class="sidebar-section-children"><a href="global.html#schema">schema</a></div><div class="sidebar-section-children"><a href="global.html#schemas">schemas</a></div><div class="sidebar-section-children"><a href="global.html#sleep">sleep</a></div><div class="sidebar-section-children"><a href="global.html#updateConfigRequestStrategy">updateConfigRequestStrategy</a></div><div class="sidebar-section-children"><a href="global.html#updatePipelineInstanceRequestStrategy">updatePipelineInstanceRequestStrategy</a></div><div class="sidebar-section-children"><a href="global.html#urlSafeBase64ToBase64">urlSafeBase64ToBase64</a></div><div class="sidebar-section-children"><a href="global.html#validateAgainstSchema">validateAgainstSchema</a></div><div class="sidebar-section-children"><a href="global.html#zxAIFormatToCamel">zxAIFormatToCamel</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>